{% extends 'base.html' %}
{% load static %}
{% block title %}Aeranta{% endblock %}

{% block content %}
<div class="d-flex justify-content-center mt-3 mb-3" style="max-width:400px; margin: 0 auto;">
  <div class="input-group">
    <input type="text" id="city-search" class="form-control" placeholder="Enter city name">
    <button id="city-search-btn" type="button" class="btn btn-outline-secondary" style="padding: 0 0.5rem;">
      ğŸ”
    </button>
  </div>
</div>

{% include 'includes/map_block.html' with map_style='height:500px' %}

<div id="preview" class="mt-2 px-2"></div>
<div id="result" class="mt-3"></div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const mapDiv = document.getElementById('map');
  const map = mapInit('map', 51.0, 10.0, 3);

  // Forecast Ğ¸ pick
  const picker = attachClickPick(map, { result: '#preview' });
  attachClickForecast(map, { endpoint: mapDiv.dataset.getUrl, result: '#result' });

  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² placeCityByName
  window.mapInstance = map;
  window.cityPicker = picker;

  // ------------------- ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ° -------------------
  const input = document.getElementById('city-search');
  const btn = document.getElementById('city-search-btn');

  async function findCity() {
    const cityName = input.value.trim();
    if (!cityName) return;

    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ³Ğ¾Ñ‚Ğ¾Ğ²ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¸Ğ· map_click.js
    await placeCityByName(cityName, map, picker);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½ÑƒÑ Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ¸ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·
    const picked = picker.getLastPicked ? picker.getLastPicked() : null;
    if (picked) {
      // Ğ¡Ğ¸Ğ¼ÑƒĞ»Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ»Ğ¸Ğº Ğ¿Ğ¾ ĞºĞ°Ñ€Ñ‚Ğµ Ğ´Ğ»Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ° Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ°
      const evt = { coordinate: ol.proj.fromLonLat([picked.lon, picked.lat]) };
      map.dispatchEvent({ type: 'singleclick', coordinate: evt.coordinate });
    }
  }

  btn.addEventListener('click', findCity);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      findCity();
    }
  });
});
</script>
{% endblock %}